package filters

import (
	"net"

	"github.com/jlorgal/odor/odor"
)

// Malware filter.
type Malware struct {
	blacklist []*net.IPNet
}

// NewMalware creates a Malware filter
func NewMalware(config *odor.Config) (*Malware, error) {
	blacklist, err := odor.GetBlacklist("malware", config)
	return &Malware{blacklist: blacklist}, err
}

// Request filters ingress packets.
func (m *Malware) Request(context *odor.Context) odor.FilterAction {
	if context.Profile == nil || !context.Profile.AntiMalware {
		return odor.Accept
	}
	if ipv4 := odor.GetIPv4Layer(context.Packet); ipv4 != nil {
		if odor.IsBlacklistedIP(m.blacklist, ipv4.DstIP) {
			return odor.Drop
		}
	}
	return odor.Accept
}

// Response filters egress packets.
func (m *Malware) Response(context *odor.Context) odor.FilterAction {
	return odor.Accept
}
